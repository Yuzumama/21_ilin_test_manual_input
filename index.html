<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title> Camera App Test 01 </title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="main_back_style">
        <div id="video_back" class="video_back_style">
            <div id="video_view" class="video_range_style">
                <video id="webcam" autoplay playsinline muted class="video_style"></video>
            </div>
            <div id="all_dests" class="empty">
                <div id="dest_01" class="dest_back_style">
                    <div id="dest_01_pot" class="dest_pot_style"></div>
                    <div id="dest_01_tri" class="dest_tri_style"></div>
                    <div id="dest_01_circle" class="dest_circle_style"></div>
                </div>
            </div>
            <!--<div class="score_board_back_style">
        <div id="score_board" class="score_board_style">
            <div class="score_style"></div>
        </div>
    </div>-->
        </div>
        <div class="video_frame_back_style">
            <div class="video_frame_style"></div>
        </div>
        <div id="button_back" class="button_back_style">
            <button id="reset_direction_btn" class="reset_direction_btn_style"></button>
            <button id="show_map_btn" class="map_btn_style"></button>
        </div>
        <div id="hint_character_back" class="hint_character_back_style">
            <div id="hint_character_img" class="hint_character_img_style">
            </div>
        </div>
        <div class="hint_character_lightbulb_back_style">
            <div id="hint_character_lightbulb" class="empty">
            </div>
        </div>
        <div id="show_chat_btn_base" class="show_chat_btn_base_style">
            <div id="show_chat_btn" class="show_chat_btn_style"></div>
        </div>
        <div class="user_hint_bubble_base_style">
            <div id="user_hint_bubble_back" class="empty">
                <div id="user_hint_bubble" class="user_hint_bubble_style">
                    ようこそ、<br>
                    もりのあんぜんきち！
                </div>
                <div id="user_hint_ok" class="user_hint_ok_style"></div>
            </div>
        </div>
        <div class="full_screen_base_style">
            <div id="title_background" class="title_background_style">
                <div>
                    <div id="title_start_2" class="title_start_2_style"></div>
                    <div id="title_start_3" class="title_start_3_style"></div>
                </div>
            </div>
        </div>
        <div class="full_screen_base_style">
            <div id="reset_hint_menu" class="empty">
                <div class="reset_hint_menu_frame_style">
                    <div class="reset_hint_image_back_style">
                        <div id="reset_hint_image" class="reset_hint_image_style"></div>
                    </div>
                    <div class="reset_hint_text_back_style">
                        <div class="reset_hint_text_style">
                            ただしいばしょをかくにんするため、
                            <br>けいたいをてのひらによこにおいてね。<br>
                            <br>あとは、きたのほうにみて、コンパスをおしてね。
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="full_screen_base_style">
            <div id="my_map_back" class="empty">
                <div id="my_map" class="my_map_style"></div>
            </div>
        </div>
        <div class="full_screen_base_style">
            <div class="hidden_btn_back_style">
                <div id="hidden_btn" class="hidden_btn_style"></div>
            </div>
            <div id="chat_main_back" class="empty">
                <div class="chat_output_back_style">
                    <div id="chat_output" class="chat_output_style">

                        <!-- My message sample
            <div class="my_message_back_style">
                <div class="my_message_style">
                    My Message !!
                </div>
                <div class="my_message_operation_back_style">
                    <div class="my_message_status_style">unseenable_msg</div>
                    <span data-key="msgKey" class="my_message_delete_btn_style"> delete </span>
                </div>
            </div>-->
                        <!-- Other one's message sample
            <div class="other_one_message_back_style">
                <div class="other_one_name_style">
                    User
                </div>
                <div class="other_one_message_style">
                    Other one's Message
                </div>
            </div>-->

                    </div>
                </div>
                <div class="chat_icon_back_style">
                    <div id="chat_icon_home" class="chat_icon_home_style"></div>
                    <div id="chat_icon_company" class="chat_icon_company_style"></div>
                    <div id="chat_icon_school" class="chat_icon_school_style"></div>
                    <div id="chat_icon_safebase" class="chat_icon_safebase_style"></div>
                </div>
                <div id="chat_option_btn_back" class="chat_option_btn_back_hide_style">
                    <button id="chat_option_btn" class="chat_option_btn_style">▲</button>
                </div>
                <div id="chat_option_back" class="chat_option_back_hide_style">
                    <div class="chat_input_back_style">
                        <textarea id="chat_input" class="chat_input_style" cols="30" rows="10"></textarea>
                        <button id="chat_send_btn" class="chat_send_btn_style"></button>
                    </div>
                    <div class="chat_user_name_back_style">
                        <div class="chat_option_item_name_style"></div>
                        <textarea id="chat_user_name" cols="30" rows="1" class="chat_user_name_style"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="dbg_msg" style="font-size: 50px;"></div>

</body>

<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->

<!-- 3d vectors ：赤いピンを描くための関数-->
<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
      }
    }
</script>
<!-- 3d vectors -->

<script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=[AniMk5fCk4W1_RLIhL9R_sYQLrR2CSTZXeOGOcvczwyrJJx3cYtlPyR8oWt10aPl]' async defer></script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm/vision_wasm_internal.js" crossorigin="anonymous"></script>

<script type="module">

    // Object detection
    import { ObjectDetector, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2";
    let objectDetector = null;
    let runningMode = "VIDEO";

    // Initialize the object detector
    const initializeObjectDetector = async () => {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.2/wasm");
        objectDetector = await ObjectDetector.createFromOptions(vision, {
            baseOptions: {
                modelAssetPath: `https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite`,
                delegate: "GPU"
            },
            scoreThreshold: 0.5,
            runningMode: runningMode,
            display_names: 'ja'
        });
    };
    initializeObjectDetector();

    let user_name = "";

    // マップゲット
    let map = null;
    window.GetMap = () => {
        map = new Microsoft.Maps.Map('#my_map', {
            center: new Microsoft.Maps.Location(35.686288, 39.749440), //Location center position
            mapTypeId: Microsoft.Maps.MapTypeId.load, //Type: [load, aerial,canvasDark,canvasLight,birdseye,grayscale,streetside]
            zoom: 18  //Zoom:1=zoomOut, 20=zoomUp[ 1~20 ]
        });
    }

    function updatePinOnMap(pos_on_server, pin_on_map) {
        if (pin_on_map != null) {
            curr_location = new Microsoft.Maps.Location(pos_on_server.latitude, pos_on_server.longitude);

            pin_on_map.setLocation(curr_location);

            if (pos_on_server.uname == user_name) {
                pin_on_map.setOptions({
                    color: "green",
                    visible: true
                });
            }
            else {
                pin_on_map.setOptions({
                    color: "blue",
                    visible: true
                });
            }
        }
    }

    // Chat
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildChanged, onChildRemoved }
    from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    //    import { getFirebaseConfig } from "./js/firebase_config.js";

    function getFirebaseConfig() {

        let sApiKey = localStorage.getItem("apiKey");
        if (sApiKey == null) {
            sApiKey = prompt("Input api key: ");
            localStorage.setItem("apiKey", sApiKey);
        }
        let sProjectId = localStorage.getItem("projectId");
        if (sProjectId == null) {
            sProjectId = prompt("Input project id: ");
            localStorage.setItem("projectId", sProjectId);
        }
        let sSenderId = localStorage.getItem("senderId");
        if (sSenderId == null) {
            sSenderId = prompt("Input sender id: ");
            localStorage.setItem("senderId", sSenderId);
        }
        let sAppId = localStorage.getItem("appId");
        if (sAppId == null) {
            sAppId = prompt("Input app id: ");
            localStorage.setItem("appId", sAppId);
        }
        let sMeasurementId = localStorage.getItem("measurementId");
        if (sMeasurementId == null) {
            sMeasurementId = prompt("Input measurement id: ");
            localStorage.setItem("measurementId", sMeasurementId);
        }

        const firebaseConfig = {
            apiKey: sApiKey,
            authDomain: sProjectId + ".firebaseapp.com",
            projectId: sProjectId,
            storageBucket: sProjectId + ".appspot.com",
            messagingSenderId: sSenderId,
            appId: sAppId,
            measurementId: sMeasurementId
        };
        return firebaseConfig;
    }

    let firebaseConfig = getFirebaseConfig();

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app)
    const dbRef = ref(db, "safe_base_chat");

    // For sharing position
    const posDbRef = ref(db, "safe_base_location");

    // Function to add minutes to current time in the gray list box
    function addMin(cur_time, min) {
        // 1 minute = 60 seconds = 60 * 1000 mili seconds
        cur_time.setTime(cur_time.getTime() + min * 60 * 1000);
        return cur_time
    }

    // Function to add seconds to current time in the gray list box
    function addSec(cur_time, sec) {
        // 1 second = 1000 mili seconds
        cur_time.setTime(cur_time.getTime() + sec * 1000);
        return cur_time;
    }

    // The array of output messages
    let messages_on_server = new Array();

    // Send arrival message
    let arrival_message_already_sent = false;

    // Settings in the gray list box
    let delay_minutes = 0;
    let delay_seconds = 0;

    // Load user name from local storage
    if (localStorage.getItem("chat_user_name")) {
        user_name = localStorage.getItem("chat_user_name");
        // If ~ getItem: to check whether user name has been used or not

        // Show user name
        $("#chat_user_name").val(user_name);
        // $ = means you want to get some information from html
    }

    // If no user name found in local storage, then randomly pick one
    else {
        user_name = "user_" + Math.floor(Math.random() * 10000).toString();
        // .toString: change number to text

        // Svae in local storage
        localStorage.setItem("chat_user_name", user_name);

        // Show user name
        $("#chat_user_name").val(user_name);
    }

    $("#chat_user_name").on("change", function () {
        user_name = $("#chat_user_name").val();

        localStorage.setItem("chat_user_name", user_name);
    })

    // Show/hide options
    let chat_option_shows = false;
    $("#chat_option_btn").on("click", function () {
        if (chat_option_shows) {
            $("#chat_option_back").attr("class", "chat_option_back_hide_style");
            $("#chat_option_btn_back").attr("class", "chat_option_btn_back_hide_style");
            chat_option_shows = false;
        }
        else {
            $("#chat_option_back").attr("class", "chat_option_back_style");
            $("#chat_option_btn_back").attr("class", "chat_option_btn_back_style");
            chat_option_shows = true;
        }
    });

    // Function to show messages in output
    function showMessages() {
        let cur_time = new Date();
        // What will show in the output box throught Html
        let h = "";
        // for loop, but for the first item
        let i = 0;

        let prev_sender = "";

        for (i = 0; i < messages_on_server.length; i += 1) {
            let msgKey = messages_on_server[i].key;
            let msg = messages_on_server[i].val();
            // Change text format to Date & Time format
            let msg_display_time = new Date(msg.displaytime);

            // Show my message
            if (msg.uname == user_name) {
                let unseenable_msg = "";
                if (cur_time < msg_display_time) {

                    // Show count down in 20 seconds = 20 * 1000 mili seconds
                    let time_to_be_seenable = msg_display_time.getTime() - cur_time.getTime();
                    if (time_to_be_seenable < 20000) {
                        unseenable_msg = "This message will be seenable in " +
                            Math.floor(time_to_be_seenable / 1000) + " seconds";
                    }

                    else {
                        // Show unseenable message to the user
                        unseenable_msg = "This message is unseenable.";
                    }
                }
                // When user send out the additional message, JS will add the additional code of message to html
                h += '<div class="my_message_back_style">' +
                    '<div class="my_message_style">' +
                    msg.text +
                    '</div>' +
                    '<div class="my_message_operation_back_style">' +
                    '<div class="my_message_status_style"> ' + unseenable_msg + ' </div>' +
//                    '<span data-key="' + msgKey + '" class="my_message_delete_btn_style"> delete </span>' +
                    '</div>' +
                    '</div>';
            }

            // Show other one's message only when the display time is passed
            else if (cur_time >= msg_display_time) {
                if (msg.uname == prev_sender) {
                    h += '<div class="other_one_message_back_style">' +
                        '<div class="other_one_message_style">' +
                        msg.text +
                        '</div>' +
                        '</div>';
                }
                else {
                    h += '<div class="other_one_message_back_style">' +
                        '<div class="other_one_name_style">' +
                        msg.uname +
                        '</div>' +
                        '<div class="other_one_message_style">' +
                        msg.text +
                        '</div>' +
                        '</div>';
                }
            }
            prev_sender = msg.uname;
        }

        $("#chat_output").html(h);
        // $().html means we want the message of output to follow html format
    }

    // Update the output every second
    setInterval(showMessages, 1000);

    $("#chat_send_btn").on("click", function () {

        // If the text is not empty
        if ($("#chat_user_input").val() != "") {
            // Get current date and time
            let display_time = new Date();

            // Calculate display time and delay time
            display_time = addMin(display_time, delay_minutes);
            display_time = addSec(display_time, delay_seconds);

            const msg = {
                displaytime: display_time.toString(),
                uname: user_name,
                text: $("#chat_input").val()
            };

            const newPostRef = push(dbRef);
            set(newPostRef, msg);

            // Reset text to empty
            $("#chat_input").val("");
        }
    });

    $("#chat_icon_home").on("click", function () {
        // Get current date and time
        let display_time = new Date();

        const msg = {
            displaytime: display_time.toString(),
            uname: user_name,
            text: "家にいるよ"
        };

        const newPostRef = push(dbRef);
        set(newPostRef, msg);
    });

    $("#chat_icon_company").on("click", function () {
        // Get current date and time
        let display_time = new Date();

        const msg = {
            displaytime: display_time.toString(),
            uname: user_name,
            text: "会社にいるよ"
        };

        const newPostRef = push(dbRef);
        set(newPostRef, msg);
    });

    $("#chat_icon_school").on("click", function () {
        // Get current date and time
        let display_time = new Date();

        const msg = {
            displaytime: display_time.toString(),
            uname: user_name,
            text: "学校にいるよ"
        };

        const newPostRef = push(dbRef);
        set(newPostRef, msg);
    });

    $("#chat_icon_safebase").on("click", function () {
        // Get current date and time
        let display_time = new Date();

        const msg = {
            displaytime: display_time.toString(),
            uname: user_name,
            text: "安全基地にいるよ"
        };

        const newPostRef = push(dbRef);
        set(newPostRef, msg);
    });

    // Check firebase's status when add new message
    onChildAdded(dbRef, function (data) {
        const msg = data.val();
        const key = data.key;//unique key

        // Add the data to array
        messages_on_server = messages_on_server.concat(data);

        // Sort the array
        messages_on_server.sort(function (a, b) {
            let a_time = new Date(a.val().displaytime);
            let b_time = new Date(b.val().displaytime);

            if (a_time < b_time) {
                return -1;
            }
            else if (a_time > b_time) {
                return 1;
            }
            else {
                return 0;
            }
        });

        // Update the output message
        showMessages();
    });

    // Check the remove message on
    onChildRemoved(dbRef, function (data) {
        const key = data.key;

        // Remove the data from array
        let i = 0;
        for (i = 0; i < messages_on_server.length; i += 1) {
            if (messages_on_server[i].key == key) {
                messages_on_server.splice(i, 1);
            }
        }

        // Update the output message
        showMessages();
    });

    // Remove message
 /*   $("#chat_output").on("click", ".my_message_delete_btn_style", function () {
        let delete_message = window.confirm('Are you sure to delete this message ?');

        if (delete_message) {
            const key = $(this).attr("data-key");
            const remove_item = ref(db, "chat/" + key);
            remove(remove_item);
        }
    });*/


    // 全員の経度・緯度・高度
    let positions_on_server = new Array();

    // マップ上表示するピン
    let positions_pin_on_map = new Array();

    // 全員の経度・緯度・高度を更新
    onChildAdded(posDbRef, function (data) {
        // Add the data to array
        positions_on_server = positions_on_server.concat(data);
        positions_pin_on_map = positions_pin_on_map.concat(null);

    });

    onChildRemoved(posDbRef, function (data) {
        const key = data.key;

        // Remove the data from array
        let i = 0;
        for (i = 0; i < positions_on_server.length; i += 1) {
            if (positions_on_server[i].key == key) {
                positions_on_server.splice(i, 1);

                // Remove the pin from map
                if (map != null) {
                    map.entities.remove(positions_pin_on_map[i]);
                }
                positions_pin_on_map.splice(i, 1);
            }
        }
    });

    onChildChanged(posDbRef, function (data) {
        const key = data.key;

        // Replace the data
        let i = 0;
        for (i = 0; i < positions_on_server.length; i += 1) {
            if (positions_on_server[i].key == key) {
                positions_on_server[i] = data;

                updatePinOnMap(positions_on_server[i].val(), positions_pin_on_map[i]);
            }
        }
    });


    /********* End of chat *********/



// 赤いピンは現実世界座標に繋がるカメラの画面に投影する3D計算のコード
    import * as THREE from 'three';

    // Check if this is a mobile device　カメラは携帯か、パソコンかを確認する
    let isMobile = false;
    // device detection
    if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
        || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))) {
        isMobile = true;
    }

    // 目的地の経度・緯度・高度
    let destLatitude = 35.7102043;
    let destLongitude = 139.7042221;
    let destAltitude = 64.2807633264114; // No altitude

    // カメラの高度
    let videoWidth = parseInt($("video").css("width"));
    let videoHeight = parseInt($("video").css("height"));
    let camera = new THREE.PerspectiveCamera(60, videoWidth / videoHeight, 0.1, 10000.0);

    // 投影される前後の所在地の経度・緯度・高度
    let currPos = new THREE.Vector3(0.0, 0.0, 0.0);
    let destPos = new THREE.Vector3(destLongitude, destLatitude, destAltitude);
    let vecToDest = new THREE.Vector3(0.0, 0.0, 0.0);
    // 距離の計算
    let vecToDestInCamera = new THREE.Vector4(0.0, 0.0, 0.0, 0.0);
    let vecToDestInCamera2 = new THREE.Vector4(0.0, 0.0, 0.0, 0.0);

    // Add destination on map　マップ上目的地を設定（ピン）
    let destAddedToMap = false;
    let dest = null;
    let dest_pin = null;
    let curr_location = null;
    let curr_pos_pin = null;
    function addDestToMap() {
        if(map != null){
            dest = new Microsoft.Maps.Location(destLatitude, destLongitude);

            dest_pin = new Microsoft.Maps.Pushpin(dest, {
                color: "red",
                draggable:false,          //MouseDraggable
                enableClickedStyle:false, //Click
                enableHoverStyle:true,   //MouseOver
                visible: true
            });

            //Add the pushpin to the map　マップ上所在地を設定（青ピン）
            map.entities.push(dest_pin);

            for (let i = 0; i < positions_on_server.length; i += 1) {
                const data = positions_on_server[i].val();
                curr_location = new Microsoft.Maps.Location(parseFloat(data.latitude), parseFloat(data.longitude));

                positions_pin_on_map[i] = new Microsoft.Maps.Pushpin(curr_location, {
                    color: "green",
                    draggable: false,          //MouseDraggable
                    enableClickedStyle: false, //Click
                    enableHoverStyle: true,   //MouseOver
                    visible: true
                });

                //Add the pushpin to the map
                map.entities.push(positions_pin_on_map[i]);
            }

            /*curr_location = new Microsoft.Maps.Location(currPos.y, currPos.x);

            curr_pos_pin = new Microsoft.Maps.Pushpin(curr_location, {
                color: "green",
                draggable:false,          //MouseDraggable
                enableClickedStyle:false, //Click
                enableHoverStyle:true,   //MouseOver
                visible:true
            });

            //Add the pushpin to the map
            map.entities.push(curr_pos_pin);*/
        }
        else {
            // Repeat until bing map api is loaded　マイクロソフトのマップの読み取りを繰り返す
            setTimeout(addDestToMap, 1000); //一秒ごとにマップ取得
        }
    }
    addDestToMap();

    // Camera forward, right, up カメラの座標を設定
    let cameraForward = new THREE.Vector3(0.0, 0.0, 0.0);
    let cameraRight = new THREE.Vector3(0.0, 0.0, 0.0);
    let cameraUp = new THREE.Vector3(0.0, 0.0, 0.0);

    // Camera video on/off　ユーザーがカメラを開く許可の設定
    let startCameraVideo = false;

    function turnOnCamera() {
        let userMedia = null;
        //Mobile 携帯のカメラ
        if (isMobile) {
            userMedia = navigator.mediaDevices.getUserMedia(
                {
                    video:
                    {
                        width: videoHeight,
                        height: videoWidth,
                        facingMode: 'environment'
                    },
                    audio: false
                });
        }
        else {
            //パソコンのカメラ
            userMedia = navigator.mediaDevices.getUserMedia(
                {
                    video:
                    {
                        width: videoWidth,
                        height: videoHeight,
                        facingMode: 'environment'
                    },
                    audio: false
                });
        }
        //ユーザーからカメラの使用許可をもらったら、カメラが撮った画像を携帯・パソコンの画面に映る
        userMedia.then((localMediaStream) => {
            const video = document.getElementById("webcam");
            video.srcObject = localMediaStream;
            video.addEventListener("loadeddata", predictWebcam);
        });

        userMedia.catch((error) => {
            alert("This app needs access to camera")
        });

        startCameraVideo = true;
    }

    // Show user hint リスの紹介言葉
    let curr_user_hint_index = 0;
    let user_hint_messages = new Array();
    user_hint_messages.push("こんにちは！　　　　ともだちのリスだよ！");
    user_hint_messages.push("きょう、いっしょにあなたをまもるばしょをさがそう！！");
    user_hint_messages.push("まず、わたしのなかまをしょうかいしよう！");
    user_hint_messages.push("いちばんひだりがわのは、ねこちゃんだ！");
    user_hint_messages.push("ねこちゃんは、こんぱすをもっている。");
    user_hint_messages.push("ばしょがわからないとき、ねこちゃんをおしてね！");
    user_hint_messages.push("つぎは、ぶたくん！ぶたくんをおしたら、ちずがでるよ！");
    user_hint_messages.push("さあ～じゅんびができたか？　いこう！！");

    $("#user_hint_ok").on("click", function () {
        // メッセージが終わる後、カメラはオンにする設定
        if (curr_user_hint_index == user_hint_messages.length) {
            turnOnCamera();
            $("#all_dests").attr("class", "all_dests_style");
        }
        //配列でメッセージを表示する
        if (curr_user_hint_index < user_hint_messages.length) {
            $("#user_hint_bubble").text(user_hint_messages[curr_user_hint_index]);
            curr_user_hint_index = curr_user_hint_index + 1;
        }
        else {
            // Hide the bubble　リスの話が終わり、メッセージの吹き出しを隠す
            $("#user_hint_bubble_back").attr("class", "empty");

            // Stop the animation　リスの口の動きを停止する設定
            $("#hint_character_img").attr("class", "hint_character_img_style");

            curr_user_hint_index = user_hint_messages.length + 1;
        }
    });

    let enableToUploadPosToServer = false;
    setTimeout(function () {
        enableToUploadPosToServer = true;
    }, 2000);

    let posHandle = 0;

    // Position success　所在地の取得
    function posSuccess(pos) {
        const crd = pos.coords;
        let currLatitude = crd.latitude;
        let currLongitude = crd.longitude;
        let currAltitude = crd.altitude;

        if (currAltitude == null) {
            currAltitude = 0.0;
        }

        currPos.x = currLongitude;
        currPos.y = currLatitude;
        currPos.z = currAltitude;

        if(map != null){
            curr_location = new Microsoft.Maps.Location(currPos.y, currPos.x);

            // Remove curr pos pin and add again with new current position
            //取得後の地図更新
            map.entities.remove(curr_pos_pin);

            curr_pos_pin = new Microsoft.Maps.Pushpin(curr_location, {
                color: "blue",
                draggable:false,          //MouseDraggable
                enableClickedStyle:false, //Click
                enableHoverStyle:true,   //MouseOver
                visible:true
            });

            //Add the pushpin to the map
            map.entities.push(curr_pos_pin);
        }

        // Share position on server
        {
            let curr_pos_on_server = null;
            for (let i = 0; i < positions_on_server.length; i += 1) {
                const data = positions_on_server[i].val();
                if (data.uname == user_name) {
                    curr_pos_on_server = positions_on_server[i];
                }
            }

            // 新しいのを作る
            if (curr_pos_on_server == null) {
                if (enableToUploadPosToServer) {
                    let display_time = new Date();

                    const msg = {
                        displaytime: display_time.toString(),
                        uname: user_name,
                        latitude: currPos.y,
                        longitude: currPos.x,
                        altitude: currPos.z
                    };

                    const newPostRef = push(posDbRef);
                    set(newPostRef, msg);
                }
            }

            else {
                const key = curr_pos_on_server.key;
                update(ref(db, "safe_base_location/" + key), {
                    latitude: currPos.y,
                    longitude: currPos.x,
                    altitude: currPos.z
                });
            }
        }
    }

    // Position fail　地図取得が失敗する時の設定
    function posFail(error) {

    }

    const posOptions = {
        enableHiAccuracy: true,
        timeout: 5000,
        maximumAge: 0
    }

    posHandle = navigator.geolocation.watchPosition(posSuccess, posFail, posOptions);

    // For calculating orientation　カメラの方向を設定
    let degree_need_initialized = true;
    let init_alpha = 0.0;
    let init_beta = 0.0;
    let init_gamma = 0.0;

    // Show/hide reset menu　猫のコンパスの設定
    let reset_menu_shows = false;
    let map_shows = false;
    let chat_shows = false;
    $("#reset_direction_btn").on("click", function () {
        //マップとチャットが出たら、猫が消える
        if(!map_shows && !chat_shows){
            if (reset_menu_shows) {
                $("#reset_hint_menu").attr("class", "empty");
                $("#show_map_btn").css("opacity", "1.0");
                $("#show_chat_btn").css("opacity", "1.0");
                reset_menu_shows = false;
            }
            else {
                //コンパスが出たら、ブタと太陽を消す
                $("#reset_hint_menu").attr("class", "reset_hint_menu_style");
                $("#show_map_btn").css("opacity", "0.0");
                $("#show_chat_btn").css("opacity", "0.0");
                reset_menu_shows = true;
            }
        }
    });
    // コンパスが出たら、北の方向を設定する
    $("#reset_hint_image").on("click", function(){
        degree_need_initialized = true;
        $("#reset_hint_menu").attr("class", "empty");
        $("#show_map_btn").css("opacity", "1.0");
        $("#show_chat_btn").css("opacity", "1.0");
        reset_menu_shows = false;
    });

    // Show/hide map　ブタのマップ設定
    $("#show_map_btn").on("click", function () {
        // コンパスとチャットが出たら、豚が消える
        if (!reset_menu_shows && !chat_shows) {
            if (map_shows) {
                $("#my_map_back").attr("class", "empty");
                $("#reset_direction_btn").css("opacity", "1");
                $("#show_chat_btn").css("opacity", "1");

                map_shows = false;
            }
            else {
                // Update current center in map　先生の事例；マップと所在地を連携する
                if (map != null) {
                    curr_location = new Microsoft.Maps.Location(currPos.y, currPos.x);

                    map.setView({
                        center: curr_location, //Location center position
                    });

                    for (let i = 0; i < positions_pin_on_map.length; i += 1) {
                        updatePinOnMap(positions_on_server[i].val(), positions_pin_on_map[i]);
                    }
                }

                $("#my_map_back").attr("class", "reset_hint_menu_style");
                $("#reset_direction_btn").css("opacity", "0");
                $("#show_chat_btn").css("opacity", "0");

                map_shows = true;
            }
        }
    });

    // Show/hide chat チャットの設定
    $("#show_chat_btn").on("click", function () {
        //マップとコンパスが出たら、太陽が消える
        if (!map_shows && !reset_menu_shows) {
            if (chat_shows) {
                $("#chat_main_back").attr("class", "empty");
                $("#show_map_btn").css("opacity", "1.0");
                $("#reset_direction_btn").css("opacity", "1.0");
                $("#hint_character_back").css("opacity", "1.0");
                chat_shows = false;
            }
            else {
                //チャットが出たら、ブタと猫を消す
                $("#chat_main_back").attr("class", "chat_main_back_style");
                $("#show_map_btn").css("opacity", "0.0");
                $("#reset_direction_btn").css("opacity", "0.0");
                $("#hint_character_back").css("opacity", "0.0");
                chat_shows = true;
            }
        }
    });

    // Device orientation　携帯の向き情報を取得する
    //https://web.dev/articles/device-orientation?hl=ja
    function dirHandler(event) {
        let absolute = event.absolute; //絶対方向、相対方向
        let deg_alpha = event.alpha;
        let deg_beta = event.beta;
        let deg_gamma = event.gamma;

        // Save first get orientation ねこのコンパスにて調整する
        if (degree_need_initialized) {
            init_alpha = deg_alpha;
            init_beta = deg_beta;
            init_gamma = deg_gamma;

            degree_need_initialized = false;
        }
        //相対方向を調整
        if (absolute == false) {
            deg_alpha -= init_alpha;
            deg_beta -= init_beta;
            deg_gamma -= init_gamma;
        }

        // Degree to radians　角度からPI
        let alpha = deg_alpha / 180.0 * Math.PI;
        let beta = deg_beta / 180.0 * Math.PI;
        let gamma = deg_gamma / 180.0 * Math.PI;

        // Create transform matrix　回転
        let trans = new THREE.Euler(
            beta, gamma, alpha, "ZXY"
        );

        //携帯の向きを初期状態から現在の向きに回転させる
        // Calculate forward (-z)
        cameraForward.x = 0.0;
        cameraForward.y = 0.0;
        cameraForward.z = -1.0;
        cameraForward.applyEuler(trans);
        cameraForward.normalize();

        // Calculate right (+x)
        cameraRight.x = 1.0;
        cameraRight.y = 0.0;
        cameraRight.z = 0.0;
        cameraRight.applyEuler(trans);
        cameraRight.normalize();

        // Calculate up (+y)
        cameraUp.x = 0.0;
        cameraUp.y = 1.0;
        cameraUp.z = 0.0;
        cameraUp.applyEuler(trans);
        cameraUp.normalize();

        // Vector to destination　携帯の現在地から目的地への方向
        vecToDest.subVectors(destPos, currPos);

        // Convert latitude and lonitude to meters　軽度・緯度からメートルに変更
        let lat_in_rad = currPos.y / 180.0 * Math.PI;
        vecToDest.x = Math.cos(lat_in_rad) * 111320.0 * vecToDest.x;
        vecToDest.y = vecToDest.y * 110574.0;

        // Transform latitude, longitude, altitude to camera space　現実世界の座標をカメラ世界の座標系に変換する
        vecToDestInCamera.x = vecToDest.dot(cameraRight);
        vecToDestInCamera.y = vecToDest.dot(cameraUp);
        vecToDestInCamera.z = vecToDest.dot(cameraForward);
        vecToDestInCamera.w = 1.0;

        vecToDestInCamera2.copy(vecToDestInCamera);
        vecToDestInCamera2.applyMatrix4(camera.projectionMatrix);//カメラ座標系への投影
        vecToDestInCamera2.divideScalar(vecToDestInCamera2.w);//遠近法の表現

        // Move the dest around camera video　映った画像のピクセルを調整する
        let xCoord = (vecToDestInCamera2.x * -1.0) * 0.5 + 0.5; // -1 ~ 1 -> 0 ~ 1
        let yCoord = (vecToDestInCamera2.y * -1.0) * 0.5 + 0.5; // -1 ~ 1 -> 0 ~ 1
        let xPosInVideo = xCoord * videoWidth;  // 0 ~ 1 -> 0 ~ width
        let yPosInVideo = yCoord * videoHeight; // 0 ~ 1 -> 0 ~ height
        let videoPaddingVer = 100;
        let videoPaddingHor = 40;
        let destWidth = parseInt($("#dest_01").css("width"));
        let destHeight = parseInt($("#dest_01").css("height"));
        let isDestOutsideVideo = (xPosInVideo < videoPaddingHor || xPosInVideo > videoWidth - videoPaddingHor ||
                                  yPosInVideo < videoPaddingVer || yPosInVideo > videoHeight - videoPaddingVer);

        //赤いピンはフレーム内にする
        let xPosInVideoClamp = Math.max(Math.min(xPosInVideo, videoWidth - videoPaddingHor), videoPaddingHor);
        let yPosInVideoClamp = videoHeight - Math.max(Math.min(yPosInVideo, videoHeight - videoPaddingVer), videoPaddingVer);

        //赤いピンの向き・角度を計算する
        let tanValue = vecToDestInCamera2.x / vecToDestInCamera2.y;
        let tanAngle = Math.atan(tanValue);

        let tanAngleInDegree = tanAngle / Math.PI * 180.0;
        if (yPosInVideo == 0.0) {
            if (xPosInVideo > 0.0) {
                tanAngle = 0.0;
            }
            else {
                tanAngle = Math.PI;
            }
        }

        if (vecToDestInCamera2.y < 0.0) {
            tanAngle = tanAngle + Math.PI;
        }

        // 赤いピンが画面外にあるとき、目的地をさすように赤いピンを回転させる
        if (isDestOutsideVideo) {
            $("#dest_01").css({
                left: xPosInVideoClamp - destWidth / 2,
                top: yPosInVideoClamp - destHeight / 2,
                transform: 'rotate(' + tanAngle + 'rad)'//回転
            });
            $("#dest_01_circle").attr("class", "empty");
        }

        // 赤いピンが画面中にある時、赤いピンを回転しないまま、目的地のところに移動させる
        else {
            $("#dest_01").css({
                left: xPosInVideoClamp - destWidth / 2,
                top: yPosInVideoClamp - destHeight / 2,
                transform: 'rotate(0deg)'
            });
            $("#dest_01_circle").attr("class", "dest_circle_style");
        }
        //目的地までの距離を計算する
        let vec2ToDest = new THREE.Vector2(vecToDest.x, vecToDest.y);
        let distToDest = vec2ToDest.length();
        let distToApproach = 10.0; // 10 meter

        // リスの話しが終わった後
        if (curr_user_hint_index > user_hint_messages.length) {

            // 目的地と逆方向の時、赤いピンを隠す
            if (vecToDestInCamera.z < 0.0) {
                $("#all_dests").attr("class", "empty");
            }
            // 目的地が画面中の時、赤いピンを表示する
            else {
                $("#all_dests").attr("class", "all_dests_style");
            }

            // Show hint if user faces wrong direction　目的地と逆方向の時、逆方向の事をユーザーにお知らせする
            // See direction
            if (vecToDestInCamera.z < 0.0) {
                $("#user_hint_bubble_back").attr("class", "user_hint_bubble_back_style");
                $("#user_hint_bubble").attr("class", "user_hint_bubble_style");
                $("#user_hint_bubble").text("ぎゃくだよ！　　　　ふりかえって。");

                // Show character image
                $("#hint_character_img").css("background-image", "url('./img/squirrel_look_side.png')");
            }

            // See distance　目的地に近く着いたとき
            else if (distToDest < distToApproach) {
                $("#user_hint_bubble_back").attr("class", "user_hint_bubble_back_style");
                $("#user_hint_bubble").attr("class", "user_hint_bubble_style");
                $("#user_hint_bubble").text("ついたよ！");

                // Show character image
                $("#hint_character_img").css("background-image", "url('./img/squirrel_laugh.png')");

                // メッセージを発信
                if (!arrival_message_already_sent) {

                    // Get current date and time
                    let display_time = new Date();

                    const msg = {
                        displaytime: display_time.toString(),
                        uname: user_name,
                        text: "あんぜんきちについたよ"
                    };

                    const newPostRef = push(dbRef);
                    set(newPostRef, msg);
                }
            }

            // Hide message and use normal character image
            else {
//                $("#user_hint_bubble_back").attr("class", "empty");

                $("#hint_character_img").css("background-image", "url('./img/squirrel_normal.png')");
            }
        }
    }

    window.addEventListener("deviceorientation", dirHandler);

    // Hide title and show character
    let title_opacity = 1.0;
    let title_background_fadeout_time = 500.0; // 500 ms
    let title_background_fadeout_update_interval = 10;  // 100 ms ごとにアップデート
    window.hideTitleAndShowCharacter = () => {
        title_opacity -= 1.0 / title_background_fadeout_time * title_background_fadeout_update_interval;

        if(title_opacity < 0.0) {
            title_opacity = 0.0;
        }

        $("#title_background").css({
            opacity: title_opacity
        });
        $("#hint_character_back").css({
            opacity: 1.0 - title_opacity
        });
        $("#button_back").css({
            opacity: 1.0 - title_opacity
        });
        $("#show_chat_btn_base").css({
            opacity: 1.0 - title_opacity
        });

        if(title_opacity > 0.0) {
            setTimeout("hideTitleAndShowCharacter();", title_background_fadeout_update_interval);
        }

        else {
            $("#title_background").attr("class", "empty");
            $("#user_hint_bubble_back").attr("class", "user_hint_bubble_back_style");
            $("#hint_character_img").attr("class", "hint_character_anim_style");
        }
    }

    $("#title_start_2").on("click", function() {
        hideTitleAndShowCharacter();
    });

    $("#title_start_3").on("click", function () {

        curr_user_hint_index = user_hint_messages.length;

        $("#user_hint_bubble").text("おかえり~ またいっしょにぼうけんしようぜ！");

        hideTitleAndShowCharacter();
    });


    let video = document.getElementById("webcam");
    let liveView = document.getElementById("video_view");

    // Keep a reference of all the child elements we create
    // so we can remove them easilly on each render.
    var children = [];
    let detect_results = [];

    let lastVideoTime = -1;
    async function predictWebcam() {

        // if image mode is initialized, create a new classifier with video runningMode.

        let startTimeMs = performance.now();
        // Detect objects using detectForVideo.
        if (video.currentTime !== lastVideoTime && objectDetector != null) {
            lastVideoTime = video.currentTime;
            const detections = objectDetector.detectForVideo(video, startTimeMs);
            displayVideoDetections(detections);
        }
        // Call this function again to keep predicting when the browser is ready.
        window.requestAnimationFrame(predictWebcam);
    }

    function displayVideoDetections(result) {
        // Remove any highlighting from previous frame.
/*        for (let child of children) {
            liveView.removeChild(child);
        }
        children.splice(0);*/

        // Remove any results from previous frame
        detect_results.splice(0);

        let liveViewOffsets = $("#video_view").offset();

        // Iterate through predictions and draw them to the live view
        for (let detection of result.detections) {
/*            const p = document.createElement("p");
            p.innerText =
                detection.categories[0].categoryName +
                " - with " +
                Math.round(parseFloat(detection.categories[0].score) * 100) +
                "% confidence.";
            p.style =
                "left: " +
                (video.offsetWidth -
                    detection.boundingBox.width -
                    detection.boundingBox.originX + liveViewOffsets.left) +
                "px;" +
                "top: " +
                (detection.boundingBox.originY + liveViewOffsets.top) +
                "px; " +
                "width: " +
                (detection.boundingBox.width - 10) +
                "px;" +
                "z-index: 3;";
            const highlighter = document.createElement("div");
            highlighter.setAttribute("class", "highlighter");
            highlighter.style =
                "left: " +
                (video.offsetWidth -
                    detection.boundingBox.width -
                    detection.boundingBox.originX + liveViewOffsets.left) +
                "px;" +
                "top: " +
                (detection.boundingBox.originY + liveViewOffsets.top) +
                "px;" +
                "width: " +
                (detection.boundingBox.width - 10) +
                "px;" +
                "height: " +
                detection.boundingBox.height +
                "px;" +
                "z-index: 3;";
            liveView.appendChild(highlighter);
            liveView.appendChild(p);
            // Store drawn objects in memory so they are queued to delete at next call.
            children.push(highlighter);
            children.push(p);*/

            // Store in memory for things
            {
                detect_results.push(detection);
            }
        }

        // See if anything found
        if ($("#user_hint_bubble_back").attr("class") == "empty" &&
            detect_results.length > 0 &&
            !map_shows &&
            !reset_menu_shows &&
            !chat_shows) {
            $("#hint_character_lightbulb").attr("class", "hint_character_lightbulb_style");
        }
        else {
            $("#hint_character_lightbulb").attr("class", "empty");
        }
    }

    let category_dict = [];
    category_dict["person"] = "人間";
    category_dict["cell phone"] = "携帯";
    category_dict["clock"] = "時計";
    category_dict["keyboard"] = "キーボード";
    category_dict["laptop"] = "ノートパソコン";
    category_dict["mouse"] = "マウス";
    category_dict["cup"] = "コップ";
    category_dict["potted plant"] = "鉢植え";
    category_dict["book"] = "本";
    category_dict["bed"] = "ベッド";
    category_dict["refrigerator"] = "冷蔵庫";
    category_dict["tv"] = "テレビ";

    function toJap(name) {
        if (category_dict[name] === undefined)
            return name;
        else
            return category_dict[name];
    }

    let display_category_name = [];

    $("#hint_character_lightbulb").on("click", function () {

        if (detect_results.length > 0) {

            // Sort objects
            detect_results.sort(function (a, b) {
                let a_area = a.boundingBox.width * a.boundingBox.height;
                let b_area = b.boundingBox.width * b.boundingBox.height;

                if (a_area > b_area) {
                    return -1;
                }
                else if (a_area < b_area) {
                    return 1;
                }
                else {
                    return 0;
                }
            })

            // 最初の三つの異なる物の名前を標示する
            display_category_name.splice(0);

            display_category_name.push(detect_results[0].categories[0].categoryName);
            let detect_index = 1;
            for (; detect_index < detect_results.length; detect_index += 1) {
                if (display_category_name[0] != detect_results[detect_index].categories[0].categoryName) {
                    display_category_name.push(detect_results[detect_index].categories[0].categoryName);
                    break;
                }
            }

            for (; detect_index < detect_results.length; detect_index += 1) {
                if (display_category_name[0] != detect_results[detect_index].categories[0].categoryName &&
                    display_category_name[1] != detect_results[detect_index].categories[0].categoryName) {
                    display_category_name.push(detect_results[detect_index].categories[0].categoryName);
                    break;
                }
            }

            let display_msg = "これは " + toJap(display_category_name[0]);
            if (display_category_name.length > 1) {
                display_msg = display_msg + " と " + toJap(display_category_name[1]);
            }
            if (display_category_name.length > 2) {
                display_msg = display_msg + " と " + toJap(display_category_name[2]);
            }
            display_msg = display_msg + " だね！";

            $("#user_hint_bubble_back").attr("class", "user_hint_bubble_back_style");
            $("#user_hint_bubble").html(display_msg);
        }
    });

    $("#hidden_btn").on("click", function () {
        alert("Get ready");

        let sApiKey = prompt("Input api key: ");
        localStorage.setItem("apiKey", sApiKey);

        let sProjectId = prompt("Input project id: ");
        localStorage.setItem("projectId", sProjectId);

        let sSenderId = prompt("Input sender id: ");
        localStorage.setItem("senderId", sSenderId);

        let sAppId = prompt("Input app id: ");
        localStorage.setItem("appId", sAppId);

        let sMeasurementId = prompt("Input measurement id: ");
        localStorage.setItem("measurementId", sMeasurementId);
    });

</script>

</html>